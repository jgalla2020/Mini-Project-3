---
Importing and Cleaning Data from CRSP-COMPUSTAT and CRSP: Full Set
---

```{Importing Libraries}
library(tidyverse)
library(tidyquant)
library(ggplot2)
library(readxl)
library(stringr)
library(gridExtra)
library(reshape2)
library(readr)

```

```{Importing Excel Table}
CRSP_COMPUSTAT_Data <- read_excel("Desktop/Rice REU/Financial Data Distribution/CRSP-COMPUSTAT Data.xlsx", 
    col_types = c("text", "date", "numeric", 
        "text", "text", "text", "text", "text", 
        "text", "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "text", "numeric", "numeric", 
        "numeric", "text", "numeric"))
View(CRSP_COMPUSTAT_Data)

CRSP_Finance_Fundamentals <- read_csv("Downloads/CRSP Finance Fundamentals.csv", 
    col_types = cols(date = col_date(format = "%Y%m%d"), 
        PRC = col_number(), SHROUT = col_number()))

View(CRSP_Finance_Fundamentals)

```

```{Creating Useful Functions}
#Coverage Function
cov <- function(vector){
  round((length(na.omit(vector))/length(vector))*100, digits = 2)
}

```

```{Creating and Cleaning Data Frame - CCM}
CRCOMP <- data.frame(CRSP_COMPUSTAT_Data)
view(CRCOMP)

#Renaming column names
colnames(CRCOMP)[1:3] <- c("S&P_Identifier", "Date", "Year")
colnames(CRCOMP)[8] <- "Stock_Ticker"
colnames(CRCOMP)[11] <- "Shares_Outstanding"
colnames(CRCOMP)[13:16] <- c("Long_Term_Debt", "EBITDA", "Preferred_Stock", "Exchange_Code")
colnames(CRCOMP)[18:20] <- c("Dividends_Per_Share", "Market_Cap_Given", "Closing_Price")
colnames(CRCOMP)[22] <- "S&P_Economic_Sector_Code"

#Removing unnecessary columns
CRCOMP$Standard.and.Poor.s.Identifier <- NULL
CRCOMP$Industry.Format <- NULL
CRCOMP$Level.of.Consolidation...Company.Annual.Descriptor <- NULL
CRCOMP$Population.Source <- NULL
CRCOMP$Data.Format <- NULL
CRCOMP$ISO.Currency.Code <- NULL
CRCOMP$Active.Inactive.Status.Marker <- NULL
CRCOMP$GIC.Sectors <- NULL


#Formatting classes
CRCOMP_C$Date <- as.Date(CRCOMP_C$Date)

#Removing data that correlates with Exchange Codes of 0, 1, and 3
for (i in c(0, 1, 3)){
  CRCOMP <- subset(CRCOMP, CRCOMP$Exchange_Code != i)
  CRCOMP_C <- CRCOMP
}
CRCOMP_C

```

```{Creating and Cleaning Data Frame - CRSP}
#Deleting unnecessary columns
CRSP_Finance_Fundamentals$PERMNO <- NULL
CRSP_Finance_Fundamentals$SICCD <- NULL

#Renaming column names
colnames(CRSP_Finance_Fundamentals) <- c("Date", "Exchange_Code", "Stock_Ticker", "Closing_Price", "Shares_Outstanding")

#Removing data that correlates with Exchange Codes of 0, 1, and 3
CRSP <- CRSP_Finance_Fundamentals

for (i in c(0, 1, 3)){
  CRSP <- subset(CRSP, CRSP$Exchange_Code != i)
  CRSP_C <- CRSP
}

#Changing Shares_Oustanding column to be in millions for unit consistency between CRCOMP_C and CRSP_C
CRSP_C$Shares_Outstanding <- CRSP_C$Shares_Outstanding/1000

CRSP_C

```

```{Testing Variable Matches}
#Finding rows with corresponding stock tickers by left joining CRSP_C to CRCOMP_C
CRCOMP_CRSP_T <- CRCOMP_C %>%
  left_join(CRSP_C, by = c("Date", "Stock_Ticker"), suffix = c("_CRCOMP_C", "_CRSP_C"))

#Checking that values match by subsetting Variable X and Y
X <- subset(CRCOMP_CRSP_T, Date == as.Date("1990-12-31"))

X$Market_Cap_Given <- NULL

Y <- na.omit(X)

c(subset(Y, Stock_Ticker == "AK")$Shares_Outstanding_CRCOMP_C, subset(Y, Stock_Ticker == "AK")$Shares_Outstanding_CRSP_C) %>% diff()
c(subset(Y, Stock_Ticker == "ACU")$Shares_Outstanding_CRCOMP_C, subset(Y, Stock_Ticker == "ACU")$Shares_Outstanding_CRSP_C) %>% diff()
c(subset(Y, Stock_Ticker == "AE")$Shares_Outstanding_CRCOMP_C, subset(Y, Stock_Ticker == "AE")$Shares_Outstanding_CRSP_C) %>% diff()
c(subset(Y, Stock_Ticker == "AMS")$Shares_Outstanding_CRCOMP_C, subset(Y, Stock_Ticker == "AMS")$Shares_Outstanding_CRSP_C) %>% diff()

#In these shares outstanding values, CRCOMP_C and CRSP_C shares outsanding differ in value by an order of magnitude of 10^3

#Expanding check
Z <- subset(CRCOMP_CRSP_T, Date >= as.Date("1990-12-31") & Date <= as.Date("2021-05-31"))

Z$Market_Cap_Given <- NULL

Z <- na.omit(Z)

#Creating Index function
index <- function(vec)
{
  match(vec, vec)
}

mean_diff <- 0

for (j in 1:459)
{
 if (all.equal(subset(Z, Stock_Ticker == unique(Z$Stock_Ticker)[j])$Shares_Outstanding_CRCOMP_C, subset(Z, Stock_Ticker == unique(Z$Stock_Ticker)[j])$Shares_Outstanding_CRSP_C) == TRUE)
 {
   mean_diff[j] <- "Mean relative difference: 0"
 } else
 {
   mean_diff[j] <- all.equal(subset(Z, Stock_Ticker == unique(Z$Stock_Ticker)[j])$Shares_Outstanding_CRCOMP_C, subset(Z, Stock_Ticker == unique(Z$Stock_Ticker)[j])$Shares_Outstanding_CRSP_C)
 }
}

mean_diff <- as.numeric(gsub("Mean relative difference: ", "", mean_diff))

max(mean_diff)
mean(mean_diff)
min(mean_diff)

```

```{Joining the CCM and CRSP Data Tables}
CRCOMP_CRSP <- CRCOMP_C %>%
  full_join(CRSP_C, by = c("Date", "Stock_Ticker"), suffix = c("_CRCOMP_C", "_CRSP_C"))
#Incluir los tickers. Si me esta dando lo doble, usar los common shares outstanding. Cambiar los nombres. 
#Checar que los valores correspondan si pretendo reemplazar. 

#Rearranging columns
col_order <- c("Date", "Year", "Stock_Ticker", "Cash.and.Short.Term.Investments", "Debt.in.Current.Liabilities...Total", "Long_Term_Debt", "EBITDA", "Preferred_Stock", "Dividends_Per_Share", "S&P_Identifier", "S&P_Economic_Sector_Code", "Closing_Price_CRCOMP_C", "Closing_Price_CRSP_C", "Shares_Outstanding_CRCOMP_C", "Shares_Outstanding_CRSP_C", "Exchange_Code_CRCOMP_C", "Exchange_Code_CRSP_C", "Market_Cap_Given")

CRCOMP_CRSP <- CRCOMP_CRSP[, col_order]

```

```{Adding Columns of Derived Calculations & Year Column - CRCOMP_CRSP_CIF (Joint WRDS Databases)}
#Subsetting CRCOMP_CRSP to table with only columns of interest
CRCOMP_CRSP_I <- CRCOMP_CRSP[, c(1:9, 11, 12:18)]

#Adding Enterprise Value column
CRCOMP_CRSP_I$EV <- (CRCOMP_CRSP_I$Closing_Price_CRSP_C)*(CRCOMP_CRSP_I$Shares_Outstanding_CRSP_C) + CRCOMP_CRSP_I$Long_Term_Debt + CRCOMP_CRSP_I$Debt.in.Current.Liabilities...Total + CRCOMP_CRSP_I$Preferred_Stock - CRCOMP_CRSP_I$Cash.and.Short.Term.Investments

#Binding CRCOMP_CRSP_CI and calculated values
CRCOMP_CRSP_CIF <- data.frame(Calculated_Market_Capital = (CRCOMP_CRSP_I$Shares_Outstanding_CRSP_C)*(CRCOMP_CRSP_I$Closing_Price_CRSP_C),
                          Calculated_Dividend_Yield = (CRCOMP_CRSP_I$Dividends_Per_Share)/(CRCOMP_CRSP_I$Closing_Price_CRSP_C),
                          Calculated.EBITDA.EV = (CRCOMP_CRSP_I$EBITDA)/(CRCOMP_CRSP_I$EV)) %>% cbind(CRCOMP_CRSP_I)
#Added three Calculated Market Cap, Dividend Yield, and EBITDA/EV

#Adding year column
CRCOMP_CRSP_CIF <- CRCOMP_CRSP_CIF %>% mutate(Year = format(as.Date(Date), "%Y"))

CRCOMP_CRSP_CIF <- CRCOMP_CRSP_CIF[c(colnames(CRCOMP_CRSP_CIF)[1:4], "Year", colnames(CRCOMP_CRSP_CIF)[5:20])]

CRCOMP_CRSP_CIF$Year.1 <- NULL

CRCOMP_CRSP_CIF

```

```{Calculating Coverages - CRCOMP_CRSP_CIG (Joint WRDS Databases)}
#Calculating Coverages using the cov (Coverage Function)
CRCOMP_CRSP_CIG <- sapply(CRCOMP_CRSP_CIF, cov) %>% data.frame()

#Converting row names into the first column of CRCOMP_CRSP_CIF, removing periods and renaming columns
Description <- gsub("\\.", " ", rownames(CRCOMP_CRSP_CIG)) %>% str_squish()
Description <- gsub("_", " ", Description) %>% str_squish()
Description <- gsub("CRSP C", "CRSP_C", Description) %>% str_squish()
Description <- gsub("CRCOMP C", "CRCOMP_C", Description) %>% str_squish()
Description <- gsub("EBITDA EV", "EBITDA/EV", Description) %>% str_squish()

Description[20] <- "Market Cap (Given)"

CRCOMP_CRSP_CIG <- cbind(Description, data.frame(CRCOMP_CRSP_CIG, row.names = NULL))

colnames(CRCOMP_CRSP_CIG)[2] <- "Coverage (%)"

CRCOMP_CRSP_CIG
```

```{Adding Columns of Derived Calculations & Year Column - CRCOMP_CIF}
CRCOMP_CI <- CRCOMP_C[,-c(1:4)]

CRCOMP_CI$EV <- (CRCOMP_CI$Closing_Price)*(CRCOMP_CI$Shares_Outstanding) + CRCOMP_CI$Long_Term_Debt + CRCOMP_CI$Debt.in.Current.Liabilities...Total + CRCOMP_CI$Preferred_Stock - CRCOMP_CI$Cash.and.Short.Term.Investments

#Binding CRCOMP_CI and calculated values
CRCOMP_CIF <- data.frame(Calculated_Dividend_Yield = (CRCOMP_CI$Dividends_Per_Share)/(CRCOMP_CI$Closing_Price),
                          Calculated_EBITDA_EV = (CRCOMP_CI$EBITDA)/(CRCOMP_CI$EV)) %>% cbind(CRCOMP_CI)

```

```{Calculating Coverages - CRCOMP_CIG}
#Calculating Coverages using the cov (Coverage Function)
CRCOMP_CIG <- sapply(CRCOMP_CIF, cov) %>% data.frame()

Description <- gsub("\\.", " ", rownames(CRCOMP_CIG)) %>% str_squish()
Description <- gsub("_", " ", rownames(CRCOMP_CIG)) %>% str_squish()
Description[c(2,3,5)] <- c("Calculated EBITDA/EV", "Cash and Short Term Investments", "Debt in Current Liabilities")

CRCOMP_CIG <- cbind(Description, data.frame(CRCOMP_CIG, row.names = NULL))

colnames(CRCOMP_CIG)[2] <- "Coverage (%)"

CRCOMP_CIG

```

```{Adding Calculated Market Cap Column & Year Column - CRSP_CIF}
CRSP_CI <- CRSP_C[, -1]

CRSP_CI$Calculated_Market_Cap <- (CRSP_CI$Closing_Price)*(CRSP_CI$Shares_Outstanding)

CRSP_CIF <- CRSP_CI

```

```{Calculating Coverages - CRSP_CIG}
#Calculating Coverages using the cov (Coverage Function)
CRSP_CIG <- sapply(CRSP_CIF, cov) %>% data.frame()

#Renaming column one to description column - run when reviewing since there is another Description
Description <- gsub("_", " ", rownames(CRSP_CIG)) %>% str_squish()

CRSP_CIG <- cbind(Description, data.frame(CRSP_CIG, row.names = NULL))

colnames(CRSP_CIG)[2] <- "Coverage (%)"

CRSP_CIG

```

```{Renaming Description Columns in CRSP_CIG, CRCOMP_CIG, and CRCOMP_CRSP_CIG Data Frame}
#Replacing characters in CRSP_CIG Data Frame
##No renaming necessary

#Replacing characters in CRCOMP_CIG Data Frame
CRCOMP_CIG$Description[c(7, 11, 14)] <- c("Earnings Before Interest (EBITDA)", "Market Cap (Given)", "Enterprise Value (EV)")

CRCOMP_CIG

#Replacing characters in CRCOMP_CRSP_CIG Data Frame
CRCOMP_CRSP_CIG$Description

```

```{Exporting CRCOMP_FINAL Data Frame as a PDF Final}
pdf("CRCOMP_FINAL.pdf", height = 11, width = 8.5)
grid.table(CRCOMP_FINAL)
dev.off()
#Try out new methods of creating a table! 
```
